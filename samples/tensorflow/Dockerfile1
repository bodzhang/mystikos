FROM ubuntu:18.04

# Install some basic utilities
RUN apt-get update && apt-get install -y \
    python3-dev python3-pip python3-venv \
    curl \
    gnupg

RUN curl https://bazel.build/bazel-release.pub.gpg | apt-key add - \
    && echo "deb [arch=amd64] https://storage.googleapis.com/bazel-apt stable jdk1.8" | tee /etc/apt/sources.list.d/bazel.list \
    && apt-get update \
    && apt-get install -y bazel-3.1.0 git

RUN git clone https://github.com/tensorflow/tensorflow \
    && cd tensorflow \
    && git checkout v2.3.0

RUN python3 -m venv ~/.virtualenvs/tf_dev

RUN pip3 install -U pip six 'numpy<1.19.0' wheel setuptools mock 'future>=0.17.1' \
    && pip3 install -U keras_applications --no-deps \
    && pip3 install -U keras_preprocessing --no-deps

RUN ./configure

RUN bazel build --config=opt -c dbg --strip=never -c opt //tensorflow/tools/pip_package:build_pip_package

RUN ./bazel-bin/tensorflow/tools/pip_package/build_pip_package /tmp/tensorflow_pkg

RUN pip install /tmp/tensorflow_pkg/tensorflow-2.3.0-cp38-cp38-linux_x86_64.whl

# Create a working directory
RUN mkdir /app
WORKDIR /app

ADD mnist_convnet.py /app

CMD ["/bin/bash"]
# CMD ["/usr/bin/python3", "/app/torch_nn.py"]